version: '3.8'

services:
  # PDF解析API + Dify适配器
  pdf-knowledge-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pdf-knowledge-service
    ports:
      - "8000:8000"  # PDF解析API
      - "8001:8001"  # Dify适配器
    environment:
      # Milvus连接配置 - 连接到全局Milvus实例
      - MILVUS_URI=http://host.docker.internal:19530
      - MILVUS_HOST=host.docker.internal
      - MILVUS_PORT=19530

      # 适配器配置
      - ADAPTER_HOST=0.0.0.0
      - ADAPTER_PORT=8001
      - PDF_PARSER_API_URL=http://localhost:8000

      # 日志配置
      - LOG_LEVEL=INFO

      # API Key配置
      - DEFAULT_API_KEY=dify-pdf-docs-001

      # 其他可能需要的环境变量
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    volumes:
      - app_data:/app/data
      - app_logs:/app/logs
      - ./data:/app/data  # 挂载本地数据目录
      - ./logs:/app/logs  # 挂载本地日志目录
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health", "&&", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

# 网络配置
networks:
  default:
    driver: bridge
    name: pdf_parser_network

# 数据卷配置
volumes:
  app_data:
    name: pdf_parser_data
  app_logs:
    name: pdf_parser_logs
