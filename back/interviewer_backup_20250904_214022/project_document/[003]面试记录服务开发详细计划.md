# [003] 面试记录服务开发详细计划

**创建时间**: 2025-09-04  
**项目**: GUET-InduEdu 面试系统  
**目标**: 创建独立的interview-service，为Dify工作流提供面试记录管理功能

## 📋 项目概述

### 需求背景
为AI智能面试官智能体项目添加面试记录功能，实现：
- 每个用户多次面试记录管理
- 每次面试包含多个题目记录
- 每个题目包含：原题、面试者作答、面试官反馈

### 技术方案
创建独立的interview-service微服务，端口8006，复用现有MySQL数据库，通过RESTful API为Dify工作流提供面试记录相关功能。

## 🎯 核心任务分解

### 任务1: 项目结构初始化
**目标**: 创建interview-service项目基础结构
**路径**: `interviewer/test/interview-service/`
**预计时间**: 1小时

#### 子任务:
1. **创建项目目录结构**
   ```
   interviewer/test/interview-service/
   ├── config.py              # 配置文件
   ├── models.py              # 数据模型定义
   ├── database.py            # 数据库服务
   ├── interview_service.py   # 核心业务逻辑
   ├── main.py                # FastAPI主服务
   ├── requirements.txt       # 依赖包
   ├── Dockerfile             # Docker配置
   ├── docker-compose.yml     # 容器编排
   ├── start.sh               # 启动脚本
   └── README.md              # 服务文档
   ```

2. **配置基础依赖**
   - FastAPI + Uvicorn
   - SQLAlchemy + PyMySQL
   - Pydantic数据验证
   - python-dotenv环境变量
   - httpx异步HTTP客户端

### 任务2: 数据库模型设计与实现
**目标**: 实现面试记录相关的数据库表和ORM模型
**预计时间**: 2小时

#### 子任务:
1. **设计数据库表结构**
   - interview_sessions: 面试会话表
   - interview_questions: 面试题目表  
   - interview_answers: 面试回答表

2. **实现SQLAlchemy ORM模型**
   - 定义模型类和关联关系
   - 配置外键约束和级联删除
   - 添加索引优化查询性能

3. **数据库迁移脚本**
   - 创建表结构的SQL脚本
   - 数据库初始化和验证

### 任务3: 核心业务逻辑实现
**目标**: 实现面试流程管理的核心业务逻辑
**预计时间**: 3小时

#### 子任务:
1. **面试会话管理**
   - 创建面试会话
   - 开始/结束面试
   - 会话状态管理
   - 统计信息计算

2. **题目管理**
   - 批量添加题目
   - 题目排序和分类
   - 题目状态跟踪

3. **回答和反馈管理**
   - 记录面试者回答
   - 提交面试官反馈
   - 评分计算和统计

### 任务4: RESTful API接口实现
**目标**: 实现完整的API接口，便于Dify工作流调用
**预计时间**: 2.5小时

#### 子任务:
1. **面试会话API**
   - POST /interview/sessions - 创建面试会话
   - GET /interview/sessions/{user_id} - 获取用户面试列表
   - GET /interview/sessions/{session_id} - 获取会话详情
   - PUT /interview/sessions/{session_id} - 更新会话信息
   - POST /interview/sessions/{session_id}/start - 开始面试
   - POST /interview/sessions/{session_id}/finish - 结束面试

2. **题目管理API**
   - POST /interview/questions/batch - 批量添加题目
   - GET /interview/questions/{session_id} - 获取会话题目
   - PUT /interview/questions/{question_id} - 更新题目

3. **回答管理API**
   - POST /interview/answers - 提交回答
   - PUT /interview/answers/{question_id}/feedback - 提交反馈
   - GET /interview/answers/{question_id} - 获取回答详情

4. **统计查询API**
   - GET /interview/stats/{user_id} - 用户面试统计
   - GET /interview/history/{user_id} - 面试历史记录
   - GET /interview/dify/{user_id}/latest - Dify专用接口

### 任务5: 服务配置和部署
**目标**: 配置服务运行环境和部署方案
**预计时间**: 1.5小时

#### 子任务:
1. **环境配置**
   - 数据库连接配置
   - 服务端口和CORS配置
   - 日志配置和错误处理

2. **Docker配置**
   - Dockerfile编写
   - docker-compose.yml配置
   - 环境变量管理

3. **启动脚本**
   - start.sh启动脚本
   - 健康检查脚本
   - 服务管理脚本

### 任务6: 服务集成和测试
**目标**: 与现有服务集成并进行完整测试
**预计时间**: 2小时

#### 子任务:
1. **服务间通信**
   - 调用analysis-service获取用户档案
   - 错误处理和重试机制
   - 服务发现和负载均衡

2. **功能测试**
   - 单元测试编写
   - API接口测试
   - 数据库操作测试

3. **集成测试**
   - 完整面试流程测试
   - 与Dify工作流集成测试
   - 性能和并发测试

## 📊 详细实施步骤

### 步骤1: 环境准备 (30分钟)
1. 创建项目目录结构
2. 初始化Git仓库和基础文件
3. 配置开发环境和依赖

### 步骤2: 数据库设计 (90分钟)
1. 设计表结构和关系 (30分钟)
2. 实现SQLAlchemy模型 (45分钟)
3. 创建数据库迁移脚本 (15分钟)

### 步骤3: 核心逻辑开发 (180分钟)
1. 实现数据库服务层 (60分钟)
2. 实现业务逻辑层 (90分钟)
3. 添加错误处理和验证 (30分钟)

### 步骤4: API接口开发 (150分钟)
1. 实现会话管理接口 (60分钟)
2. 实现题目和回答接口 (60分钟)
3. 实现统计查询接口 (30分钟)

### 步骤5: 配置和部署 (90分钟)
1. 配置文件和环境变量 (30分钟)
2. Docker配置和脚本 (45分钟)
3. 文档编写 (15分钟)

### 步骤6: 测试和集成 (120分钟)
1. 单元测试和API测试 (60分钟)
2. 集成测试和性能测试 (45分钟)
3. 问题修复和优化 (15分钟)

## ⏱️ 时间安排

**总预计时间**: 12小时
**建议分配**: 2个工作日完成

- **第1天 (6小时)**: 完成任务1-3 (项目初始化、数据库设计、核心逻辑)
- **第2天 (6小时)**: 完成任务4-6 (API开发、部署配置、测试集成)

## 🔧 技术要求

### 开发环境
- Python 3.10+
- FastAPI 0.100+
- SQLAlchemy 2.0+
- MySQL 8.0+
- Docker & docker-compose

### 代码规范
- 遵循PEP 8代码风格
- 使用类型注解
- 完整的文档字符串
- 统一的错误处理

### 性能要求
- API响应时间 < 500ms
- 支持并发请求 > 50
- 数据库查询优化
- 合理的缓存策略

## 📝 验收标准

- [ ] 所有API接口功能正常
- [ ] 数据库操作事务安全
- [ ] 与analysis-service集成成功
- [ ] Dify工作流调用正常
- [ ] 完整的错误处理机制
- [ ] 性能指标达到要求
- [ ] 代码质量和文档完整
- [ ] Docker部署成功

## 🚨 风险控制

1. **数据一致性风险**: 使用数据库事务和外键约束
2. **服务依赖风险**: 实现熔断和降级机制
3. **性能风险**: 数据库索引优化和查询缓存
4. **安全风险**: 输入验证和SQL注入防护

## 💻 详细技术实现方案

### 数据库表结构详细设计

#### interview_sessions 表
```sql
CREATE TABLE interview_sessions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '自增主键',
    user_id VARCHAR(100) NOT NULL COMMENT '用户ID，关联candidate_profiles.user_id',
    session_id VARCHAR(100) UNIQUE NOT NULL COMMENT '面试会话唯一标识',
    session_name VARCHAR(200) COMMENT '面试名称',
    session_type VARCHAR(50) DEFAULT 'technical' COMMENT '面试类型',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '面试状态',
    difficulty_level VARCHAR(20) DEFAULT 'medium' COMMENT '面试难度',
    estimated_duration INTEGER DEFAULT 60 COMMENT '预计时长（分钟）',
    actual_duration INTEGER COMMENT '实际时长（分钟）',
    start_time TIMESTAMP COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    total_questions INTEGER DEFAULT 0 COMMENT '总题目数',
    completed_questions INTEGER DEFAULT 0 COMMENT '已完成题目数',
    average_score DECIMAL(3,2) COMMENT '平均得分',
    interviewer_notes TEXT COMMENT '面试官总体评价',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES candidate_profiles(user_id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_session_id (session_id),
    INDEX idx_status (status)
) COMMENT='面试会话表';
```

#### interview_questions 表
```sql
CREATE TABLE interview_questions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '自增主键',
    session_id VARCHAR(100) NOT NULL COMMENT '面试会话ID',
    question_id VARCHAR(100) NOT NULL COMMENT '题目唯一标识',
    question_text TEXT NOT NULL COMMENT '题目原文',
    question_type VARCHAR(50) DEFAULT 'technical' COMMENT '题目类型',
    question_category VARCHAR(100) COMMENT '题目分类',
    difficulty_level VARCHAR(20) DEFAULT 'medium' COMMENT '题目难度',
    expected_duration INTEGER DEFAULT 10 COMMENT '预期时长（分钟）',
    reference_answer TEXT COMMENT '参考答案',
    scoring_criteria TEXT COMMENT '评分标准',
    sort_order INTEGER DEFAULT 0 COMMENT '题目顺序',
    is_required BOOLEAN DEFAULT TRUE COMMENT '是否必答',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (session_id) REFERENCES interview_sessions(session_id) ON DELETE CASCADE,
    UNIQUE KEY uk_session_question (session_id, question_id),
    INDEX idx_session_id (session_id),
    INDEX idx_question_type (question_type)
) COMMENT='面试题目表';
```

#### interview_answers 表
```sql
CREATE TABLE interview_answers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '自增主键',
    question_id VARCHAR(100) NOT NULL COMMENT '题目ID',
    session_id VARCHAR(100) NOT NULL COMMENT '会话ID',
    candidate_answer TEXT COMMENT '面试者回答',
    interviewer_feedback TEXT COMMENT '面试官反馈',
    answer_quality VARCHAR(20) COMMENT '回答质量',
    technical_accuracy DECIMAL(3,2) COMMENT '技术准确性评分',
    communication_clarity DECIMAL(3,2) COMMENT '表达清晰度评分',
    problem_solving DECIMAL(3,2) COMMENT '问题解决能力评分',
    overall_score DECIMAL(3,2) COMMENT '综合评分',
    answer_duration INTEGER COMMENT '回答时长（分钟）',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '回答状态',
    answered_at TIMESTAMP COMMENT '回答时间',
    reviewed_at TIMESTAMP COMMENT '评价时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (question_id) REFERENCES interview_questions(question_id) ON DELETE CASCADE,
    FOREIGN KEY (session_id) REFERENCES interview_sessions(session_id) ON DELETE CASCADE,
    UNIQUE KEY uk_question_answer (question_id),
    INDEX idx_session_id (session_id),
    INDEX idx_status (status)
) COMMENT='面试回答表';
```

### 核心API接口规范

#### 1. 创建面试会话
```python
POST /interview/sessions
Content-Type: application/json

{
    "user_id": "candidate_001",
    "session_name": "Java后端开发面试",
    "session_type": "technical",
    "difficulty_level": "medium",
    "estimated_duration": 60
}

Response:
{
    "success": true,
    "session_id": "session_20250904_001",
    "message": "面试会话创建成功"
}
```

#### 2. 批量添加题目
```python
POST /interview/questions/batch
Content-Type: application/json

{
    "session_id": "session_20250904_001",
    "questions": [
        {
            "question_id": "q001",
            "question_text": "请介绍一下Spring Boot的自动配置原理",
            "question_type": "technical",
            "question_category": "框架",
            "difficulty_level": "medium",
            "expected_duration": 10,
            "reference_answer": "Spring Boot自动配置...",
            "scoring_criteria": "理解程度、表达清晰度、深度"
        }
    ]
}
```

#### 3. 提交面试回答
```python
POST /interview/answers
Content-Type: application/json

{
    "question_id": "q001",
    "candidate_answer": "Spring Boot的自动配置主要通过...",
    "answer_duration": 8
}
```

#### 4. 提交面试官反馈
```python
PUT /interview/answers/{question_id}/feedback
Content-Type: application/json

{
    "interviewer_feedback": "回答较为全面，但缺少具体实例",
    "technical_accuracy": 7.5,
    "communication_clarity": 8.0,
    "problem_solving": 7.0,
    "overall_score": 7.5,
    "answer_quality": "good"
}
```

### Dify工作流集成示例

#### 创建面试会话节点
```yaml
name: "创建面试会话"
type: "http"
config:
  url: "http://interview-service:8006/interview/sessions"
  method: "POST"
  headers:
    Content-Type: "application/json"
  body:
    user_id: "{{#start.user_id#}}"
    session_name: "{{#start.session_name#}}"
    session_type: "technical"
    difficulty_level: "medium"
```

#### 获取面试历史节点
```yaml
name: "获取面试历史"
type: "http"
config:
  url: "http://interview-service:8006/interview/history/{{#start.user_id#}}"
  method: "GET"
```

---

**计划制定时间**: 2025-09-04 21:33
**预计开始时间**: 2025-09-05
**预计完成时间**: 2025-09-06
**负责人**: AI Assistant
