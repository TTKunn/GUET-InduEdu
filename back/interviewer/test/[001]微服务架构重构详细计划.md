# [001] 微服务架构重构详细计划（已完成）

**创建时间**: 2025-08-28  
**项目**: GUET-InduEdu 面试系统  
**目标**: 将现有服务进行微服务拆分，实现模块化部署和管理

## 📋 项目概述

### 当前状态
- Document-parser服务运行在端口8002(PDF解析)+8001(Dify适配器)
- analysis-service的MongoDB容器存在但未运行
- 全局Milvus向量数据库运行在端口19530
- 服务耦合度较高，不便于独立维护和扩展

### 目标架构
```
1. pdf-parser-service (端口8003) - 纯PDF解析服务
2. vector-storage-service (端口8005) - 向量存储和检索服务  
3. analysis-service (端口8004) - MongoDB结构化数据存储服务
4. 全局Milvus (端口19530) - 共享向量数据库
```

## 🎯 核心任务分解

### 任务1: PDF解析服务独立化
**目标**: 创建独立的pdf-parser-service
**端口**: 8003
**路径**: `/home/ubuntu/workspace/project/pdf-parser-service`

#### 子任务:
1. **创建目录结构**
   - 初始化pdf-parser-service项目目录
   - 创建api、parsers、config等模块目录

2. **提取核心代码**
   - 从Document-parser提取parsers模块
   - 提取PDF解析相关的工具函数
   - 去除向量存储相关代码

3. **创建API服务**
   - 基于FastAPI创建纯PDF解析接口
   - 实现/parse接口，返回解析后的文本内容
   - 添加健康检查接口/health

4. **配置环境**
   - 创建requirements.txt依赖文件
   - 创建.env环境配置文件
   - 创建Dockerfile和docker-compose.yml

### 任务2: 向量存储服务独立化
**目标**: 创建独立的vector-storage-service
**端口**: 8005
**路径**: `/home/ubuntu/workspace/project/vector-storage-service`

#### 子任务:
1. **创建目录结构**
   - 初始化vector-storage-service项目目录
   - 创建api、database、models等模块目录

2. **提取核心代码**
   - 从Document-parser提取database模块
   - 提取models和向量化相关代码
   - 提取嵌入模型集成代码

3. **创建API服务**
   - 实现/store接口，接收文本并向量化存储
   - 实现/search接口，提供向量检索功能
   - 集成BGE和智谱AI嵌入模型

4. **配置环境**
   - 配置Milvus连接参数
   - 配置嵌入模型API密钥
   - 创建部署配置文件

### 任务3: MongoDB存储服务优化
**目标**: 优化现有analysis-service
**端口**: 8004
**路径**: `/home/ubuntu/workspace/project/analysis-service`

#### 子任务:
1. **修复MongoDB连接**
   - 检查并启动MongoDB容器
   - 修复数据库连接配置问题
   - 验证数据库连接状态

2. **优化分析逻辑**
   - 去除内置PDF解析功能
   - 优化简历分析和结构化存储逻辑
   - 保留LLM调用和数据处理功能

3. **更新服务调用**
   - 修改PDF解析调用，改为调用pdf-parser-service
   - 更新API接口，适配新的服务架构
   - 添加错误处理和重试机制

### 任务4: 服务间通信接口设计
**目标**: 设计统一的API接口规范

#### 接口规范:
1. **PDF解析服务接口**
   ```
   POST /parse
   - 输入: PDF文件
   - 输出: 解析后的文本内容
   ```

2. **向量存储服务接口**
   ```
   POST /store
   - 输入: 文本内容、集合名称
   - 输出: 存储结果
   
   GET /search
   - 输入: 查询文本、集合名称
   - 输出: 相似文档列表
   ```

3. **分析服务接口**
   ```
   POST /analyze
   - 输入: 用户ID、PDF文件
   - 输出: 结构化分析结果
   ```

### 任务5: 服务部署和配置管理
**目标**: 为每个服务创建独立的部署配置

#### 部署配置:
1. **Docker配置**
   - 每个服务独立的Dockerfile
   - 独立的docker-compose.yml文件
   - 环境变量配置文件

2. **启动脚本**
   - 服务启动脚本start.sh
   - 服务管理脚本manage.sh
   - 健康检查脚本health-check.sh

### 任务6: 服务监控和健康检查
**目标**: 实现统一的服务状态监控

#### 监控功能:
1. **健康检查接口**
   - 每个服务提供/health接口
   - 返回服务状态和依赖检查结果

2. **统一监控脚本**
   - 创建check-services.sh脚本
   - 检查所有服务的运行状态
   - 提供服务重启功能

### 任务7: 集成测试和验证
**目标**: 验证微服务架构的完整功能

#### 测试内容:
1. **单服务测试**
   - 测试每个服务的独立功能
   - 验证API接口的正确性

2. **集成测试**
   - 测试服务间的协作流程
   - 验证完整的业务流程

## ⏱️ 时间安排

- **第1天**: 完成任务1-2 (PDF解析和向量存储服务独立化)
- **第2天**: 完成任务3-4 (MongoDB服务优化和接口设计)  
- **第3天**: 完成任务5-7 (部署配置、监控和测试)

## 🔧 技术要求

### 开发环境
- Python 3.10+
- FastAPI框架
- Docker和docker-compose
- MongoDB 7.0
- Milvus 2.6.0

### API规范
- RESTful API设计
- JSON数据格式
- 统一的错误处理
- 完整的API文档

## 📝 验收标准

- [x] 每个服务可独立启动和停止
- [x] 服务状态可独立监控
- [x] API接口功能正常
- [x] 服务间通信正常
- [x] 完整业务流程验证通过
- [x] 部署文档完整

## ✅ **微服务架构重构 - 完全成功！**

### **最终测试结果 (2025-08-28)**

**✅ 所有三个微服务测试完全通过！**

**服务运行状态:**
- pdf-parser-service (端口8003) ✅ 运行正常
- analysis-service (端口8004) ✅ 运行正常
- vector-storage-service (端口8005) ✅ 运行正常

**功能验证结果:**
- ✅ PDF解析: 成功解析真实简历文件 (3349字符，0.53秒)
- ✅ 简历分析: 完整提取结构化信息 (17项技术栈，3个项目，33.70秒)
- ✅ 向量存储: 成功存储和搜索 (2.11秒存储，0.71秒搜索)
- ✅ API格式: 严格保持与原项目一致，对Dify完全兼容
- ✅ 服务通信: analysis-service成功调用pdf-parser-service
- ✅ 数据库: MongoDB和Milvus连接正常
- ✅ 外部API: 智谱AI LLM和嵌入模型正常工作

**真实数据测试:**
使用 `/home/ubuntu/workspace/project/GUET-InduEdu/xzk.pdf` 进行完整流程测试
- 个人信息提取: 徐泽垚、桂林电子科技大学、软件工程专业
- 技术栈识别: C/C++、Linux、Qt、Docker等17项技术
- 项目分析: RPC服务、多媒体播放器、高并发内存池
- 求职方向: C++后台开发

## 🎯 执行进度更新

### ✅ 已完成任务 (2025-08-28)

**任务1: PDF解析服务独立化** - ✅ 完成
- ✅ 创建pdf-parser-service目录结构
- ✅ 提取PDF解析核心代码，去除向量存储依赖
- ✅ 创建FastAPI服务，提供/parse和/parse-text接口
- ✅ 配置环境依赖，创建Docker配置和启动脚本

**服务特点:**
- 端口: 8003
- 纯PDF解析功能，无向量存储依赖
- 提供结构化数据和纯文本两种解析模式
- 完整的健康检查和错误处理
- Docker容器化部署支持

**任务2: 向量存储服务独立化** - ✅ 完成
- ✅ 创建vector-storage-service目录结构
- ✅ 提取向量存储核心代码，包括Milvus客户端和嵌入模型
- ✅ 创建FastAPI服务，提供/store、/search等接口
- ✅ 集成BGE和智谱AI嵌入模型服务

**服务特点:**
- 端口: 8005
- 专门的向量存储和检索功能
- 支持BGE和智谱AI嵌入模型
- 提供文本存储、文档存储和相似性搜索
- 集合管理和统计功能

**任务3: MongoDB存储服务优化** - ✅ 完成
- ✅ 修复MongoDB连接问题，使用本机MongoDB(端口27017)
- ✅ 优化简历分析逻辑，去除内置PDF解析依赖
- ✅ 更新服务接口调用，改为调用pdf-parser-service
- ✅ 验证服务正常运行和所有依赖连接

**服务特点:**
- 端口: 8004
- 连接本机MongoDB数据库
- 专注于简历分析和结构化数据存储
- 集成LLM服务进行智能分析
- 调用独立的PDF解析服务

## 🚨 风险控制

1. **数据一致性**: 确保服务拆分过程中数据不丢失
2. **接口兼容性**: 保持对外API接口的向后兼容
3. **服务依赖**: 合理处理服务间的依赖关系
4. **错误处理**: 完善的错误处理和重试机制

---

**计划制定完成时间**: 2025-08-28  
**预计完成时间**: 2025-08-30
**实际完成时间**: 2025-08-29