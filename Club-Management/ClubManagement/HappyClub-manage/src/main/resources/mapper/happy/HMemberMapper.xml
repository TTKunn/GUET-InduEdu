<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guet.happy.mapper.HMemberMapper">

    <resultMap id="HMemberResultMap" type="com.guet.happy.domain.HMember">
        <id property="membershipId" column="membership_id"/>
        <result property="userId" column="user_id"/>
        <result property="clubId" column="club_id"/>
        <result property="joinTime" column="join_time"/>
        <result property="status" column="status"/>
        <result property="exitTime" column="exit_time"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="totalStudyDuration" column="total_study_duration"/>
        <result property="activityParticipation" column="activity_participation"/>
        <result property="achievementCount" column="achievement_count"/>
    </resultMap>

    <!-- 根据用户id查看是否是该社团成员 -->
    <select id="selectMemberByUserId" resultMap="HMemberResultMap">
        select * from tb_membership where user_id = #{userId}
    </select>

    <!-- 查看社团成员 -->
    <select id="selectMembersByClubId" resultMap="HMemberResultMap">
        select * from tb_membership where club_id = #{clubId} and status  not in('quit', 'failed')
    </select>

<!--  判断是否是该社团成员  -->
    <select id="checkMember">
        select count(*) from tb_membership where user_id = #{userId} and club_id = #{clubId} and status  not in('quit', 'failed')
    </select>
<!--  退出社团  -->
    <update id="exitClub">
        update tb_membership set exit_time = now(), status = 'quit' where user_id = #{userId} and club_id = #{clubId}
    </update>
<!--  申请加入社团  -->
    <insert id="joinClub">
        INSERT INTO tb_membership (user_id, club_id, join_time, status)
        VALUES (#{userId}, #{clubId}, NOW(), 'apply')
        ON DUPLICATE KEY UPDATE
                             status = 'apply',
                             join_time = NOW()
    </insert>
<!--    -->
    <!-- 插入入社申请记录 -->
<insert id="insertJoinApplication">
    INSERT INTO tb_application (user_id, club_id, type, status, user_remark, created_at)
    VALUES (#{userId}, #{clubId}, 'join', 'pending', #{remark}, NOW())
</insert>

<!-- 插入退社申请记录 -->
<insert id="insertQuitApplication">
    INSERT INTO tb_application (user_id, club_id, type, status, user_remark, created_at)
    VALUES (#{userId}, #{clubId}, 'quit', 'pending', #{remark}, NOW())
</insert>

</mapper>