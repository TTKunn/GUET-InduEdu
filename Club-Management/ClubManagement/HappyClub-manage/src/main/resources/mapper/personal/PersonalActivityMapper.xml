<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guet.personal.mapper.PersonalActivityMapper">
    
    <resultMap type="PersonalActivityVo" id="PactivityResult">
        <result property="activityId"    column="activity_id"    />
        <result property="clubId"    column="club_id"    />
        <result property="name"    column="name"    />
        <result property="description"    column="description"    />
        <result property="startTime"    column="start_time"    />
        <result property="endTime"    column="end_time"    />
        <result property="location"    column="location"    />
        <result property="organizerId"    column="organizer_id"    />
        <result property="visibility"    column="visibility"    />
        <result property="status"    column="status"    />
        <result property="deletedAt"    column="deleted_at"    />
        <result property="userName" column="organizer_name"/>
        <result property="clubName" column="club_name"/>
        <result property="nickName" column="nick_name"/>
    </resultMap>

    <sql id="selectPactivityVo">
        select activity_id,
               tb_activity.club_id,
               tb_activity.name,
               tb_activity.description,
               tb_club.name as club_name,
               start_time,
               end_time,
               location,
               sys_user.user_name as organizer_name,
               visibility,
               tb_activity.status,
               sys_user.nick_name
        from tb_activity
                 join tb_club on tb_activity.club_id = tb_club.club_id
                 join sys_user on tb_activity.organizer_id = sys_user.user_id
    </sql>

    <select id="selectPactivityList" parameterType="PersonalActivityDto" resultMap="PactivityResult">
        <include refid="selectPactivityVo"/>
        <where>
<!--            visibility-->
            <if test="visibility != null and visibility != ''">and visibility = #{visibility}</if>
            <if test="description != null  and description != ''">and description like concat('%', #{description},
                '%')
            </if>
            <if test="nickName != null and nickName != ''">
                and sys_user.nick_name like concat('%', #{nickName}, '%')
            </if>
            <if test="clubName != null and clubName != ''">
                and tb_club.name like concat('%', #{clubName}, '%')
            </if>
            <if test="userName != null and userName != ''">
                and sys_user.user_name like concat('%', #{userName}, '%')
            </if>
            <if test="location != null and location != ''">
                and location like concat('%', #{location}, '%')
            </if>
            <if test="name != null  and name != ''">
                and tb_activity.name like concat('%', #{name}, '%')
            </if>
            <if test="status != null  and status != ''">
                and tb_activity.status = #{status}
            </if>
            <if test="params.beginStartTime != null and params.beginStartTime != '' and params.endStartTime != null and params.endStartTime != ''">
                and start_time between #{params.beginStartTime} and #{params.endStartTime}
            </if>
            <if test="params.beginEndTime != null and params.beginEndTime != '' and params.endEndTime != null and params.endEndTime != ''">
                and end_time between #{params.beginEndTime} and #{params.endEndTime}
            </if>
                and tb_activity.club_id = #{clubId}
        </where>
        order by start_time desc
    </select>
    
    <select id="selectPactivityByActivityId" parameterType="Long" resultMap="PactivityResult">
        <include refid="selectPactivityVo"/>
        where activity_id = #{activityId}
    </select>

    <insert id="insertPactivity" parameterType="PersonalActivity" useGeneratedKeys="true" keyProperty="activityId">
        insert into tb_activity
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="clubId != null">club_id,</if>
            <if test="name != null and name != ''">name,</if>
            <if test="description != null and description != ''">description,</if>
            <if test="startTime != null">start_time,</if>
            <if test="endTime != null">end_time,</if>
            <if test="location != null and location != ''">location,</if>
            <if test="organizerId != null">organizer_id,</if>
            <if test="visibility != null">visibility,</if>
            <if test="status != null">status,</if>
            <if test="deletedAt != null">deleted_at,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="clubId != null">#{clubId},</if>
            <if test="name != null and name != ''">#{name},</if>
            <if test="description != null and description != ''">#{description},</if>
            <if test="startTime != null">#{startTime},</if>
            <if test="endTime != null">#{endTime},</if>
            <if test="location != null and location != ''">#{location},</if>
            <if test="organizerId != null">#{organizerId},</if>
            <if test="visibility != null">#{visibility},</if>
            <if test="status != null">#{status},</if>
            <if test="deletedAt != null">#{deletedAt},</if>
         </trim>
    </insert>

    <update id="updatePactivity" parameterType="PersonalActivity">
        update tb_activity
        <trim prefix="SET" suffixOverrides=",">
            <if test="clubId != null">club_id = #{clubId},</if>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="description != null and description != ''">description = #{description},</if>
            <if test="startTime != null">start_time = #{startTime},</if>
            <if test="endTime != null">end_time = #{endTime},</if>
            <if test="location != null and location != ''">location = #{location},</if>
            <if test="organizerId != null">organizer_id = #{organizerId},</if>
            <if test="visibility != null">visibility = #{visibility},</if>
            <if test="status != null">status = #{status},</if>
            <if test="deletedAt != null">deleted_at = #{deletedAt},</if>
        </trim>
        where activity_id = #{activityId}
    </update>

    <delete id="deletePactivityByActivityId" parameterType="Long">
        delete from tb_activity where activity_id = #{activityId}
    </delete>

    <delete id="deletePactivityByActivityIds" parameterType="String">
        delete from tb_activity where activity_id in 
        <foreach item="activityId" collection="array" open="(" separator="," close=")">
            #{activityId}
        </foreach>
    </delete>

    <insert id="insertPactivityAudit" parameterType="com.guet.personal.domain.Dto.Audit.PersonalActivityAuditDto" useGeneratedKeys="true" keyProperty="auditId">
        INSERT INTO tb_audit (type, applicant_id, related_id, status)
        VALUES (#{type}, #{applicantId}, #{activityId}, #{status})
    </insert>

    <insert id="insertActivityVisibility">
        insert into tb_activity_visibility(activity_id, club_id)
        values (#{activityId}, #{clubId})
    </insert>
</mapper>